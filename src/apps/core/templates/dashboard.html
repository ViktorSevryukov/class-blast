{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% load extra_filters %}

{% block info_message %}
  <div class="info-message">
    <h3>{{ info_message.title }}</h3>
    <div>{{ info_message.text }}</div>
  </div>

{% endblock %}

{% block content %}

  <div class="table-wrapper">
    <table id="manager-table" class="infinite-container table table-striped">
      <tr>
        <th></th>
        <th></th>
        <th colspan="2">Course</th>
        <th>Location</th>
        <th>Instructor</th>
        <th>TC, TS</th>
        <th>Roster Limit</th>
        <th>Cutoff</th>
        <th>Description/<br>Student Notes</th>
      </tr>
      {% for ew_group in ew_groups %}

        <!-- Enroll Row -->
        <tr class="infinite-item row-group background-enroll {% if not ew_group.available_to_export %}blurred{% endif %}">
          <td rowspan="2" class="background-white">
            {% if ew_group.available_to_export %}
              <div class="row-check">
                <input id="check-{{ ew_group.id }}"
                       class="group-check check-control"
                       type="checkbox"
                       onclick="checkExportAvailable()">
              </div>
            {% endif %}
          </td>
          <td>
            <div class="cell-div">
              <span class="service-name">Enrollware</span>
            </div>
          </td>
          <td class="td-sm">
            <div class="cell-div">
              <!-- enroll date -->
              <div>{{ ew_group.get_class_time }}</div>
              <!-- /enroll date -->
            </div>
          </td>
          <td class="td-md">
            <div class="cell-div">
              <!-- enroll course -->
              <div>{{ ew_group.course }}</div>
              <!-- /enroll course -->
            </div>
          </td>
          <td class="td-md">
            <div class="cell-div">
              <!-- enroll location -->
              <div>{{ ew_group.location }}</div>
              <!-- /enroll location -->
            </div>
          </td>
          <td class="td-md">
            <div class="cell-div">
              <!-- enroll instructor -->
              <div>{{ ew_group.instructor }}</div>
              <!-- /enroll instructor -->
            </div>
          </td>
          <td rowspan="2"
              class="td-md background-white">
            <!-- TC -->
            <div class="cell-div">
              <div class="select-field-wrapper">
                <select title="Please, select the Training Center"
                        {% if not ew_group.available_to_export %}
                        disabled
                        {% endif %}
                        id="aha-tc-{{ ew_group.id }}"
                        name="training_center"
                        class="form-control select-field">
                  {% if aha_fields.tc|length > 1 %}
                    <option value="">-</option>
                  {% endif %}

                  {% for option in aha_fields.tc %}
                    <option value="{{ option|get_value }}">
                      {{ option|get_text }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <!-- TS -->
              <div class="select-field-wrapper">
                <select title="Please, select the Training Site"
                        {% if not ew_group.available_to_export %}
                        disabled
                        {% endif %}
                        id="aha-ts-{{ ew_group.id }}"
                        name="training_site"
                        class="form-control select-field">
                  {% if aha_fields.ts|length > 1 %}
                    <option value="">-</option>
                  {% endif %}
                  {% for option in aha_fields.ts %}
                    <option value="{{ option|get_value }}">
                      {{ option|get_text }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <!-- /TS -->
            </div>

          </td>
          <!-- /TC -->

          <td rowspan="2" class="td-xs background-white">
            <div class="cell-div">
              <input
                      {% if not ew_group.available_to_export %}
                        disabled
                      {% endif %}
                        type="number" min="0"
                        id="aha-roster-limit-{{ ew_group.id }}"
                        class="input-sm form-control"
                        name="roster_limit"
                        value={{ ew_group.max_students }}>
            </div>
          </td>

          <td rowspan="2" class="td-sm background-white">
            <div class="cell-div">
              <input
                      {% if not ew_group.available_to_export %}
                        disabled
                      {% endif %}
                        id="aha-cutoff-date-{{ ew_group.id }}"
                        class="input-sm form-control aha-cutoff-date"
                        name="cutoff_date"
                        value={{ ew_group.get_cutoff_date }}>
            </div>
          </td>

          <td rowspan="2" class="td-sm background-white">
            <div class="cell-div">
              <input onclick="clickOnPreview({{ ew_group.id }})"
                      {% if not ew_group.available_to_export %}
                     disabled
                      {% endif %}id="aha-descriptions-preview-{{ ew_group.id }}"
                     class="form-control aha-descriptions-preview"
                     type="text" title="Please, add class description"
                     size="50" required readonly
                     value="{{ ew_group.get_default_description }}">
            </div>
          </td>

        </tr>
        <!-- /Enroll Row-->

        <!-- AHA Row -->
        <tr class="infinite-item row-group {% if not ew_group.available_to_export %}blurred{% endif %}
          {% if ew_group.status == ew_group.STATUS_CHOICES.ERROR %}background-error{% else %}background-aha{% endif %}">
          <td>
            <div class="cell-div">
              <span class="service-name">AHA</span>
            </div>
          </td>
          <td colspan="2"
              class="td-md {% if ew_group.status == ew_group.STATUS_CHOICES.ERROR %}td-colored-error{% else %}td-colored{% endif %}">
            <div class="cell-div">
              <!-- aha course -->
              <div class="select-field-wrapper">
                <select title="Please, select the course"
                        {% if not ew_group.available_to_export %}
                        disabled
                        {% endif %}
                        id="aha-course-{{ ew_group.id }}"
                        name="course"
                        class="form-control select-field">
                  {% if aha_fields.course|length > 1 %}
                    <option value="">-</option>
                  {% endif %}
                  {% for option in aha_fields.course %}
                    <option
                            {% if option|get_value == ew_group.get_default_course %}
                              selected
                            {% endif %}
                              value="{{ option|get_value }}">
                      {{ option|get_text }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <!-- /aha course -->
          </td>
          <td class="td-md {% if ew_group.status == ew_group.STATUS_CHOICES.ERROR %}td-colored-error{% else %}td-colored{% endif %}">
            <div class="cell-div">
              <!-- aha location -->
              <div class="select-field-wrapper">
                <select title="Please, select the location"
                        {% if not ew_group.available_to_export %}
                        disabled
                        {% endif %}
                        id="aha-location-{{ ew_group.id }}"
                        name="location"
                        class="form-control select-field">

                  {% if aha_fields.location|length > 1 %}
                    <option value="">-</option>
                  {% endif %}
                  {% for option in aha_fields.location %}
                    <option
                            {% if option|get_value == ew_group.get_default_location %}
                              selected
                            {% endif %}
                              value="{{ option|get_value }}">
                      {{ option|get_text }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <!-- /aha location -->
          </td>
          <td class="td-md {% if ew_group.status == ew_group.STATUS_CHOICES.ERROR %}td-colored-error{% else %}td-colored{% endif %}">
            <div class="cell-div">
              <!-- aha instructor -->
              <div class="select-field-wrapper">
                <select title="Please, select the instructor"
                        {% if not ew_group.available_to_export %}
                        disabled
                        {% endif %}
                        id="aha-instructor-{{ ew_group.id }}"
                        name="instructor"
                        class="form-control select-field">
                  {% if aha_fields.instructor|length > 1 %}
                    <option value="">-</option>
                  {% endif %}
                  {% for option in aha_fields.instructor %}
                    <option
                            {% if option|get_value == ew_group.get_default_instructor %}
                              selected
                            {% endif %}
                              value="{{ option|get_value }}">
                      {{ option|get_text }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <!-- /aha instructor -->
          </td>

        </tr>
        <!-- /AHA Row-->

        <!-- dialog with description and student notes -->
        <div class="dialog-descriptions"
             id="dialog-descriptions-{{ ew_group.id }}"
             title="Description/ Student notes">
          <span>Description <span class="text">*</span></span>
          <input onkeypress="updateDescriptionsPreview(this, {{ ew_group.id }})"
                 id="aha-class-description-{{ ew_group.id }}"
                 class="form-control" name="class_description" type="text"
                 size="50" value="{{ ew_group.get_default_description }}">
          <span>Student notes</span>
          <input id="aha-class-notes-{{ ew_group.id }}"
                 class="form-control" name="class_notes" type="text"
                 size="50" value="{{ ew_group.get_default_notes }}">

        </div>
        <!-- /dialog with description and student notes -->
      {% endfor %}

    </table>

    <!-- PAYMENT BUTTON -->

    {% if not request.user.version == request.user.VERSIONS.PRO %}
      <div id="payment-block">

        <img src="{% static "img/icons/lock-locked.png" %}">
        <div class="payment-form-wrapper">
          <span class="pay-text">Pay to sync all classes</span>
          <form action="/dashboard/payment/" method="POST">{% csrf_token %}
            <script
                    src="https://checkout.stripe.com/checkout.js"
                    class="stripe-button"
                    data-key="pk_test_yD2VY8XsjaHMUrG1fRYMmTdP"
                    data-amount="999"
                    data-name="Class Blast"
                    data-description="Pro Plan"
                    data-image="https://stripe.com/img/documentation/checkout/marketplace.png"
                    data-locale="auto">
            </script>
          </form>
        </div>

      </div>
    {% endif %}
    <!-- /PAYMENT BUTTON -->

  </div>

  <div class="next-page-loading" style="display: none;">
    <img src="{% static "img/loader.gif" %}"
         id="infinite-loader" class="loader">

    {% if page_obj.has_next %}
      <div>
        <a class="infinite-more-link"
           href="?page={{ page_obj.next_page_number }}">more</a>
      </div>
    {% endif %}
  </div>



  <div id="controls-panel">

    <div id="loader-wrapper">
      {#        <span>Process in progress... </span>#}
      <img src="{% static "img/loader.gif" %}"
           id="export-loader" class="loader">
    </div>

    <div id="export-controls">
      <div class="import-form">
        <button class="btn btn-primary" id="sync-button"
                onclick="sync()">Import from Enrollware
        </button>
      </div>

      <div class="export-form">
        <button disabled class="btn btn-primary" id="export-button"
                onclick="exportGroups()">Export to AHA
        </button>
      </div>
    </div>
  </div>


{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'libs/jquery.waypoints.min.js' %}"></script>
  <script src="{% static 'libs/infinite.min.js' %}"></script>

  <script>
      var infinite = new Waypoint.Infinite({
          element: $('.infinite-container')[0],
          onBeforePageLoad: function () {
              $('.next-page-loading').show();
          },
          onAfterPageLoad: function ($items) {
              $('.next-page-loading').hide();
          }
      });
  </script>
{% endblock %}